---
title: "Comparing Shape Descriptors: CSS, Wavelets, and Elliptic Fourier"
author: "aforoR Package Team"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Comparing Shape Descriptors}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>"
)
```

```{r setup}
library(aforoR)
```

## Introduction

In otolith shape analysis, choosing the right mathematical descriptor is crucial for capturing the biological information relevant to your study. The `aforoR` package provides three main methods: **Elliptic Fourier Descriptors (EFD)**, **Wavelet Transform**, and **Curvature Scale Space (CSS)**.

This vignette explains their differences, advantages, and typical use cases.

## Overview Comparison

| Descriptor | Domain | Best For... | Invariance |
|:---|:---|:---|:---|
| **Elliptic Fourier (EFD)** | Frequency (global) | General shape classification, reconstruction | Translation, Rotation, Scale |
| **Wavelets** | Time-Frequency (local) | High-frequency details, stock separation | Translation, Scale (if normalized) |
| **Curvature Scale Space (CSS)** | Multi-scale Geometry | Feature detection, contour irregularities | Rotation, Translation, Uniform Scale |

```{r load_real_data}
# Load a sample otolith image from the package
img_path <- system.file("extdata", "otolith.jpg", package = "aforoR")
binary_img <- preprocess_image(img_path)
contour <- extract_contour(binary_img)
```

---

## 1. Elliptic Fourier Descriptors (EFDs)

EFDs represent a closed contour as a sum of ellipses (harmonics). Each harmonic is defined by four coefficients.

- **How it works**: It decomposes the $x$ and $y$ projections of the contour into Fourier series.
- **Advantages**: Excellent for capturing the overall "global" shape. Higher harmonics capture more detail.
- **Typical Use**: Evolutionary studies, morphospace analysis, and species identification.

```{r efd_example}
# Using Momocs integration in aforoR
ef_coefs <- Momocs::efourier(contour, nb.h = 32)
# The result contains the harmonic coefficients
head(ef_coefs$coe)
```

---

## 2. Wavelet Transform

Wavelets provide a way to analyze the contour at different frequency levels while maintaining spatial localization.

- **How it works**: It treats the radius (polar) or step-length (perimeter) distance from the centroid as a signal and decomposes it using a mother wavelet.
- **Advantages**: Can pinpoint *where* a feature is on the contour. Scale 1-2 captures noise/fine detail, while 5-9 captures the main shape.
- **Typical Use**: Stock separation and phenotype discrimination where fine-grained differences in margins are important.

```{r wavelets_example}
dists <- calculate_distances(contour)
wavelets <- calculate_wavelets_analysis(dists, n_scales = 9)
plot(wavelets$polar[5, ],
    type = "l",
    main = "Wavelet Scale 5 (Polar distances)",
    xlab = "Point index", ylab = "Coefficient Value"
)
```

---

## 3. Curvature Scale Space (CSS)

CSS focuses on the **geometry of the contour** by tracking inflection points (where the curve changes from concave to convex) as the shape is progressively smoothed.

- **How it works**: The contour is smoothed with Gaussian kernels of increasing scale ($\sigma$). We record the position of inflection points at each scale to create a "CSS Image".
- **Advantages**: Extremely robust to noise and rotation. It naturally identifies significant "concavities" or "protrusions" (lobes).
- **Typical Use**: Detailed analysis of contour irregularities and detecting structural features like lobes.

```{r css_example}
# Calculate and plot CSS using the real otolith contour
css_res <- calculate_css(contour)
plot(css_res)
```

## Summary: Which one should I use?

1.  **Use EFD** if you need a standard, globally accepted method for broad shape differences (e.g., comparing species).
2.  **Use Wavelets** if you are looking for local differences in margin complexity between populations of the same species.
3.  **Use CSS** if you want to quantify specific geometric features like the number and depth of protrusions/lobes regardless of their orientation.

## References

-   Kuhl, F.P. and Giardina, C.R. (1982). Elliptic Fourier features of a closed contour.
-   Mokhtarian, F. and Mackworth, A.K. (1986). Scale-based description and recognition of planar curves and two-dimensional shapes.
-   Parisi-Baradad, V. et al. (2005). Otolith shape contour analysis using mathematical descriptors.
